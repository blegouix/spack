#/bin/bash
set -e


echo -e "\n\n******* Adding required spack repositories *******\n"
if [ ! -e ${SPACK_ROOT}/var/spack/repos/pdi ]
then
    cp -a /opt/spack-pdi ${SPACK_ROOT}/var/spack/repos/pdi
    spack repo add ${SPACK_ROOT}/var/spack/repos/pdi || true
fi

echo -e "\n\n******* Solve *******\n"
spack solve -I --reuse \
    pdi@develop \
    pdiplugin-decl-hdf5@develop \
    pdiplugin-decl-netcdf@develop \
    pdiplugin-mpi@develop \
    pdiplugin-pycall@develop \
    pdiplugin-serialize@develop \
    pdiplugin-set-value@develop \
    pdiplugin-trace@develop \
    pdiplugin-user-code@develop


echo -e "\n\n******* Installation *******\n"
spack install --fail-fast --show-log-on-error --reuse \
    pdi@develop \
    pdiplugin-decl-hdf5@develop \
    pdiplugin-decl-netcdf@develop \
    pdiplugin-mpi@develop \
    pdiplugin-pycall@develop \
    pdiplugin-serialize@develop \
    pdiplugin-set-value@develop \
    pdiplugin-trace@develop \
    pdiplugin-user-code@develop
